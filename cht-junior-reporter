<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç”Ÿæ´»å®‰å…¨å°è¨˜è€… - æ°¸çºŒå°ˆæ¥­ç‰ˆ</title>
  
  <!-- å¼•å…¥ Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@600;900&display=swap" rel="stylesheet">

  <style>
    /* æ°¸çºŒä¸»é¡Œé…è‰² */
    :root { --b:#2e7d32; --g:#c8e6c9; --mut:#558b2f; --bg:#f1f8e9; }
    
    /* å…¨ç«™åŸºç¤è¨­å®š */
    body {
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0; 
      color: #1b5e20;
      padding-bottom: 40px;
      background-color: var(--bg);
      background-image: url('https://lh3.googleusercontent.com/d/1PMMbc6X59Ifwywx8fg2beaCXEBB_iBtZ');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-repeat: no-repeat;
    }
    
    /* èª¿æ•´ä¸»å€å¡Šé€æ˜åº¦ */
    .wrap { 
      max-width: 800px; 
      margin: 20px auto; 
      padding: 24px; 
      background: rgba(255, 255, 255, 0.85); 
      border-radius: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      backdrop-filter: blur(3px); 
    }

    /* === æ ¸å¿ƒï¼šå­—é«”è¨­å®š === */
    .font-kaiti {
      font-family: "KaiTi", "BiauKai", "DFKai-SB", "STKaiti", "Noto Serif TC", serif;
    }

    /* === æ ¸å¿ƒï¼šåœ‹å°èª²æœ¬é¢¨æ ¼æ³¨éŸ³æ’ç‰ˆ (å‚ç›´å †ç–Š) === */
    .z-word {
      display: inline-flex;
      align-items: center;
      margin: 0 0.35rem 0 0;
      vertical-align: middle;
      font-family: "KaiTi", "BiauKai", "DFKai-SB", "STKaiti", "Noto Serif TC", serif;
      position: relative;
      white-space: nowrap; 
    }
    .z-char {
      font-size: 1.6rem; 
      line-height: 1;
      font-weight: bold;
      color: #1b5e20;
      margin-right: 4px;
    }
    .z-yin {
      display: inline-flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      position: relative;
      width: 0.8rem;
      font-size: 0.6rem;
      line-height: 1;
      color: #33691e;
      font-weight: normal;
      overflow: visible;
    }
    .yin-symbol { 
      display: block; 
      height: 0.6rem; 
      line-height: 0.6rem;
      text-align: center;
    }
    
    /* è²èª¿å®šä½ */
    .tone {
      position: absolute;
      font-family: system-ui, sans-serif;
      font-size: 0.6rem;
    }
    .tone-2, .tone-3, .tone-4 {
      right: -0.25rem; 
      top: 50%; 
      transform: translateY(-50%); 
      width: 0.5rem;
      text-align: left;
    }
    .tone-0 {
      top: -0.5rem; 
      left: 50%; 
      transform: translateX(-50%);
    }

    /* é‡å°å¤§æ¨™é¡Œä¿æŒè¼ƒå¤§å°ºå¯¸ */
    h1 .z-char { font-size: 2.4rem; color: #1b5e20; }
    h1 .z-yin { font-size: 0.9rem; width: 1rem; }
    h1 .tone-2, h1 .tone-3, h1 .tone-4 { right: -0.9rem; font-size:0.9rem; width: 0.8rem; }
    h1 .yin-symbol { height: 0.9rem; line-height: 0.9rem; }
    
    /* æ–°èç¨¿æ¨™é¡Œä¿æŒåŸæ¨£ */
    #report h1 .z-char { font-size: 2.4rem; }
    #report h1 .z-yin { font-size: 0.9rem; width: 1rem; }
    
    /* === èª¿æ•´å€åŸŸï¼šæ­¥é©Ÿæ¨™é¡Œç¸®å° === */
    .step-text .z-char { font-size: 1.3rem; } /* ç¸®å°æ­¥é©Ÿæ¨™é¡Œ */
    .step-text .z-yin { font-size: 0.5rem; width: 0.6rem; }
    .step-text .yin-symbol { height: 0.5rem; line-height: 0.5rem; }
    .step-text .tone-2, .step-text .tone-3, .step-text .tone-4 { right: -0.3rem; width: 0.3rem; font-size: 0.5rem; }
    .step-text .tone-0 { font-size: 0.5rem; }

    /* === èª¿æ•´å€åŸŸï¼šè¡¨å–®æ¨™ç±¤æ–‡å­—å¤§å° (åŒ…å«å½±éŸ¿å±¤é¢) === */
    label .z-char { font-size: 16px; } /* æ”¹å› 16px */
    label .z-yin { font-size: 0.4rem; width: 0.6rem; }
    label .yin-symbol { height: 0.4rem; line-height: 0.4rem; }
    label .tone-2, label .tone-3, label .tone-4 { right: -0.3rem; font-size: 0.4rem; width: 0.4rem; }
    label .tone-0 { top: -0.3rem; font-size: 0.4rem; }

    /* å¡«ç©ºå…§å®¹æ¨£å¼ */
    .input-highlight {
      font-family: "KaiTi", "BiauKai", "DFKai-SB", "STKaiti", "Noto Serif TC", serif;
      font-size: 1.6rem; 
      font-weight: bold;
      color: #000;
      text-decoration: underline;
      text-decoration-color: #888;
      text-decoration-thickness: 2px;
      text-underline-offset: 5px;
      margin: 0 4px;
      vertical-align: middle;
    }
    #rTitle.input-highlight { font-size: 2rem !important; }

    /* ç¯„ä¾‹æ–‡å­—æ¨£å¼ */
    .input-example {
      display: flex;
      align-items: center;
      margin-top: 6px;
      color: #666;
      font-size: 13px;
      flex-wrap: wrap;
    }
    .input-example .z-char { font-size: 0.9rem; color: #555; }
    .input-example .z-yin { font-size: 0.35rem; width: 0.5rem; color: #777; }
    .input-example .yin-symbol { height: 0.35rem; line-height: 0.35rem; }
    .input-example .tone-2, .input-example .tone-3, .input-example .tone-4 { 
      right: -0.3rem; width: 0.3rem; font-size: 0.35rem;
    }
    .input-example .tone-0 { font-size: 0.35rem; }

    /* UI å…ƒä»¶ */
    .card { 
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid #a5d6a7; 
      border-radius: 16px; 
      padding: 16px; 
      box-shadow: 0 4px 6px rgba(46, 125, 50, 0.05);
      margin-bottom: 16px; 
    }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .between { justify-content: space-between; }
    
    .btn {
      border: 1px solid var(--b); background: #388e3c; color: #fff; 
      padding: 10px 16px; border-radius: 12px; cursor: pointer; 
      font-size: 14px; display: inline-flex; align-items: center; gap: 6px;
      font-weight: bold; transition: all 0.2s; box-shadow: 0 2px 0 #1b5e20;
    }
    .btn:active { transform: translateY(2px); box-shadow: none; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; background: #81c784; border-color: #81c784; box-shadow: none; }
    .btn.secondary { background: #fff; color: #2e7d32; border: 1px solid #2e7d32; box-shadow: none; }
    .btn.back { background: #e8f5e9; color: #1b5e20; border: 1px solid #a5d6a7; box-shadow: none; }
    .btn.large { width: 100%; justify-content: center; font-size: 16px; padding: 12px; background: #2e7d32; border-color: #2e7d32; }
    
    .step-badge {
      font-size: 13px; font-weight: bold; color: #1b5e20;
      background: #c8e6c9; padding: 3px 10px; 
      border-radius: 12px 0 12px 0; font-family: system-ui, sans-serif; border: 1px solid #81c784;
    }

    .canvasWrap {
      position: relative; width: 100%; 
      border: 2px dashed #81c784; border-radius: 12px; 
      overflow: hidden; background: #f1f8e9;
      display: flex; justify-content: center; align-items: center;
      min-height: 250px; 
    }
    canvas { display: block; max-width: 100%; height: auto; touch-action: none; cursor: crosshair; }
    
    .two { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
    @media (max-width: 600px){ .two { grid-template-columns: 1fr; } }
    
    label { display: block; margin-bottom: 6px; font-weight: bold; color: #2e7d32; }
    input[type="text"], select {
      width: 100%; padding: 10px; border: 1px solid #a5d6a7; border-radius: 10px;
      font-size: 15px; 
      box-sizing: border-box; background: #fff;
      font-family: "KaiTi", "BiauKai", "STKaiti", "Noto Serif TC", serif; 
      color: #333;
    }
    input[type="text"]:focus, select:focus { outline: none; border-color: #2e7d32; background: #f1f8e9; }
    
    /* Qç‰ˆéŒ„éŸ³æŒ‰éˆ•æ¨£å¼ */
    .btn.record { 
        background: #66bb6a;
        border: none;
        padding: 8px; 
        box-shadow: 0 3px 0 #2e7d32;
        border-radius: 50%;
        width: 36px; height: 36px;
        display: flex; align-items: center; justify-content: center;
        transition: all 0.1s;
        touch-action: manipulation;
    }
    .btn.record:active { transform: translateY(3px); box-shadow: none; }
    .btn.recording { animation: pulse 1s infinite; background: #ef5350; box-shadow: 0 3px 0 #c62828; }
    @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.1);} 100% {transform: scale(1);} }
    
    .input-group { display: flex; gap: 8px; margin-top: 6px; align-items: center; }
    .input-group input { flex: 1; }

    .checkbox-group { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 5px; }
    .checkbox-label {
      display: flex; align-items: center; gap: 4px; cursor: pointer;
      background: #e8f5e9; padding: 6px 10px; border-radius: 8px; border: 1px solid #c8e6c9;
    }
    .checkbox-label input { width: auto; margin: 0; transform: scale(1.1); }

    .page-section { display: none; animation: fadeIn 0.3s; }
    .page-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .report-container { overflow-x: auto; padding: 10px; background: #334d34; border-radius: 8px; }
    
    /* å¿«å ±é è¦½å€æ¨£å¼èª¿æ•´ */
    #report {
      width: 794px; height: 1123px; padding: 40px;
      /* å¿«å ±èƒŒæ™¯ */
      background: linear-gradient(rgba(255, 255, 255, 0.75), rgba(255, 255, 255, 0.75)), url('https://lh3.googleusercontent.com/d/1PMMbc6X59Ifwywx8fg2beaCXEBB_iBtZ');
      background-size: cover;
      background-position: center;
      margin: 0 auto;
      font-family: "KaiTi", "BiauKai", "DFKai-SB", "STKaiti", "Noto Serif TC", serif; 
      box-sizing: border-box;
      position: relative; display: flex; flex-direction: column;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    
    /* æ–°èç¨¿æ’ç‰ˆ */
    .news-header {
      border-bottom: 2px solid #2e7d32; margin-bottom: 10px; padding-bottom: 5px;
      position: relative; 
    }
    .news-title-box {
      text-align: center; margin-bottom: 10px;
    }
    #rTitle .z-char { font-size: 2rem !important; }
    #rTitle .z-yin { font-size: 0.7rem !important; width: 0.8rem; }
    #rTitle.input-highlight { font-size: 2rem !important; }

    .news-info {
      display: flex; justify-content: space-between; align-items: flex-end;
      color: #555; font-size: 16px; margin-bottom: 5px;
    }
    
    /* å…§æ–‡å€åŸŸèˆ‡ç…§ç‰‡é…ç½®å„ªåŒ– */
    .news-content-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 15px;
      overflow: hidden; 
    }

    /* ç…§ç‰‡é«˜åº¦é™åˆ¶ */
    .news-photo-box {
      width: 100%; 
      height: 250px; 
      flex: 0 0 250px; 
      border: none; /* ç„¡é‚Šæ¡† */
      background: #fff; /* ç™½åº•ï¼Œé¿å…ç°åº• */
      display: flex; 
      align-items: center; 
      justify-content: center; 
      overflow: hidden;
    }
    .news-photo-box img {
        height: 100%; /* é«˜åº¦å›ºå®š */
        width: auto;  /* å¯¬åº¦è‡ªå‹• */
        max-width: 100%; /* ä¸è¶…å‡ºé‚Šç•Œ */
        object-fit: contain;
    }

    .news-content-block {
      line-height: 2.4; 
      font-size: 15px;  
      text-align: justify;
      flex-grow: 1;
    }
    .news-content-block p {
      margin: 10px 0;
      text-indent: 2em; 
    }
    .news-footer {
      margin-top: auto; text-align: center; color: #555; font-size: 14px;
      border-top: 1px solid #aaa; padding-top: 10px;
      font-weight: bold;
    }

    .hidden { display: none !important; }
    .text-center { text-align: center; }
    .mt-4 { margin-top: 16px; }
  </style>
</head>

<body>

  <div class="wrap">
    
    <!-- === é é¢ 1ï¼šç·¨è¼¯å€ === -->
    <div id="page-edit" class="page-section active">
      
      <div style="text-align:center; margin-bottom:20px;">
        <!-- é¦–é  Logo -->
        <img src="https://lh3.googleusercontent.com/d/1ybyLQCc_DIAUeS23tz-sORNL43Vv2Kan" style="height: 80px; display: block; margin: 0 auto 10px auto;" alt="Logo">
        
        <h1>
          <!-- æ¨™é¡Œï¼šæ°¸çºŒç”Ÿæ´»å°è¨˜è€… -->
          <span class="z-word"><span class="z-char">æ°¸</span><span class="z-yin"><span class="yin-symbol">ã„©</span><span class="yin-symbol">ã„¥</span><span class="tone tone-3">Ë‡</span></span></span><span class="z-word"><span class="z-char">çºŒ</span><span class="z-yin"><span class="yin-symbol">ã„’</span><span class="yin-symbol">ã„©</span><span class="tone tone-4">Ë‹</span></span></span><span class="z-word"><span class="z-char">ç”Ÿ</span><span class="z-yin"><span class="yin-symbol">ã„•</span><span class="yin-symbol">ã„¥</span></span></span><span class="z-word"><span class="z-char">æ´»</span><span class="z-yin"><span class="yin-symbol">ã„</span><span class="yin-symbol">ã„¨</span><span class="yin-symbol">ã„›</span><span class="tone tone-2">ËŠ</span></span></span><span class="z-word"><span class="z-char">å°</span><span class="z-yin"><span class="yin-symbol">ã„’</span><span class="yin-symbol">ã„§</span><span class="yin-symbol">ã„ </span><span class="tone tone-3">Ë‡</span></span></span><span class="z-word"><span class="z-char">è¨˜</span><span class="z-yin"><span class="yin-symbol">ã„</span><span class="yin-symbol">ã„§</span><span class="tone tone-4">Ë‹</span></span></span><span class="z-word"><span class="z-char">è€…</span><span class="z-yin"><span class="yin-symbol">ã„“</span><span class="yin-symbol">ã„œ</span><span class="tone tone-3">Ë‡</span></span></span>
        </h1>
      </div>

      <!-- æ­¥é©Ÿ 1 -->
      <div class="card">
        <div class="row between">
          <div class="row step-text">
            <span class="step-badge">æ­¥é©Ÿ 1</span>
            <span class="z-word"><span class="z-char">ä¸Š</span><span class="z-yin"><span class="yin-symbol">ã„•</span><span class="yin-symbol">ã„¤</span><span class="tone tone-4">Ë‹</span></span></span>
            <span class="z-word"><span class="z-char">å‚³</span><span class="z-yin"><span class="yin-symbol">ã„”</span><span class="yin-symbol">ã„¨</span><span class="yin-symbol">ã„¢</span><span class="tone tone-2">ËŠ</span></span></span>
            <span class="z-word"><span class="z-char">ç…§</span><span class="z-yin"><span class="yin-symbol">ã„“</span><span class="yin-symbol">ã„ </span><span class="tone tone-4">Ë‹</span></span></span>
            <span class="z-word"><span class="z-char">ç‰‡</span><span class="z-yin"><span class="yin-symbol">ã„†</span><span class="yin-symbol">ã„§</span><span class="yin-symbol">ã„¢</span><span class="tone tone-4">Ë‹</span></span></span>
          </div>
        </div>
        <div style="margin-top:15px;">
          <input id="photoInput" type="file" accept="image/*" style="width:100%; padding:10px;" />
        </div>
      </div>

      <!-- æ­¥é©Ÿ 2 -->
      <div class="card">
        <div class="row between">
          <div class="row step-text">
            <span class="step-badge">æ­¥é©Ÿ 2</span>
            <span class="z-word"><span class="z-char">åœˆ</span><span class="z-yin"><span class="yin-symbol">ã„‘</span><span class="yin-symbol">ã„©</span><span class="yin-symbol">ã„¢</span></span></span>
            <span class="z-word"><span class="z-char">é¸</span><span class="z-yin"><span class="yin-symbol">ã„’</span><span class="yin-symbol">ã„©</span><span class="yin-symbol">ã„¢</span><span class="tone tone-3">Ë‡</span></span></span>
            <span class="z-word"><span class="z-char">å•</span><span class="z-yin"><span class="yin-symbol">ã„¨</span><span class="yin-symbol">ã„£</span><span class="tone tone-4">Ë‹</span></span></span>
            <span class="z-word"><span class="z-char">é¡Œ</span><span class="z-yin"><span class="yin-symbol">ã„Š</span><span class="yin-symbol">ã„§</span><span class="tone tone-2">ËŠ</span></span></span>
          </div>
          <div class="row">
            <button class="btn secondary" id="btnUndo" type="button" disabled>â†© å¾©åŸ</button>
            <button class="btn secondary" id="btnClear" type="button" disabled>ğŸ—‘ æ¸…é™¤</button>
          </div>
        </div>
        <div class="canvasWrap" style="margin-top:10px;">
          <div id="placeholderText" style="color:#558b2f;">ğŸ“¸ è«‹å…ˆé¸æ“‡ç…§ç‰‡</div>
          <canvas id="canvas" class="hidden"></canvas>
        </div>
        <div style="margin-top:10px; text-align:center; font-size:13px; color:#558b2f;">
          <span id="drawStatus">â€» é»æ“Šä¸­å¿ƒä¸¦æ‹–æ›³ï¼Œæ‹‰å‡ºç´…è‰²åœˆé¸ (å¯è‡ªç”±èª¿æ•´é•·å¯¬)</span>
        </div>
      </div>

      <!-- æ­¥é©Ÿ 3 -->
      <div class="card">
        <div class="row step-text">
          <span class="step-badge">æ­¥é©Ÿ 3</span>
          <span class="z-word"><span class="z-char">å¡«</span><span class="z-yin"><span class="yin-symbol">ã„Š</span><span class="yin-symbol">ã„§</span><span class="yin-symbol">ã„¢</span><span class="tone tone-2">ËŠ</span></span></span>
          <span class="z-word"><span class="z-char">å¯«</span><span class="z-yin"><span class="yin-symbol">ã„’</span><span class="yin-symbol">ã„§</span><span class="yin-symbol">ã„</span><span class="tone tone-3">Ë‡</span></span></span>
          <span class="z-word"><span class="z-char">è³‡</span><span class="z-yin"><span class="yin-symbol">ã„—</span></span></span>
          <span class="z-word"><span class="z-char">æ–™</span><span class="z-yin"><span class="yin-symbol">ã„Œ</span><span class="yin-symbol">ã„§</span><span class="yin-symbol">ã„ </span><span class="tone tone-4">Ë‹</span></span></span>
        </div>

        <div class="two">
          <div>
            <label>
              <span class="z-word"><span class="z-char">å°</span><span class="z-yin"><span class="yin-symbol">ã„’</span><span class="yin-symbol">ã„§</span><span class="yin-symbol">ã„ </span><span class="tone tone-3">Ë‡</span></span></span>
              <span class="z-word"><span class="z-char">çµ„</span><span class="z-yin"><span class="yin-symbol">ã„—</span><span class="yin-symbol">ã„¨</span><span class="tone tone-3">Ë‡</span></span></span>
            </label>
            <select id="team">
              <option value="" disabled selected>è«‹é¸æ“‡</option>
              <option value="Açµ„">Açµ„</option>
              <option value="Bçµ„">Bçµ„</option>
              <option value="Cçµ„">Cçµ„</option>
              <option value="Dçµ„">Dçµ„</option>
              <option value="Eçµ„">Eçµ„</option>
            </select>
          </div>
          <div>
            <label>
              <span class="z-word"><span class="z-char">å°</span><span class="z-yin"><span class="yin-symbol">ã„’</span><span class="yin-symbol">ã„§</span><span class="yin-symbol">ã„ </span><span class="tone tone-3">Ë‡</span></span></span>
              <span class="z-word"><span class="z-char">è¨˜</span><span class="z-yin"><span class="yin-symbol">ã„</span><span class="yin-symbol">ã„§</span><span class="tone tone-4">Ë‹</span></span></span>
              <span class="z-word"><span class="z-char">è€…</span><span class="z-yin"><span class="yin-symbol">ã„“</span><span class="yin-symbol">ã„œ</span><span class="tone tone-3">Ë‡</span></span></span>
              <span class="z-word"><span class="z-char">å§“</span><span class="z-yin"><span class="yin-symbol">ã„’</span><span class="yin-symbol">ã„§</span><span class="yin-symbol">ã„¥</span><span class="tone tone-4">Ë‹</span></span></span>
              <span class="z-word"><span class="z-char">å</span><span class="z-yin"><span class="yin-symbol">ã„‡</span><span class="yin-symbol">ã„§</span><span class="yin-symbol">ã„¥</span><span class="tone tone-2">ËŠ</span></span></span>
            </label>
            <input id="reporterName" type="text" placeholder="è«‹è¼¸å…¥å§“å">
          </div>
        </div>

        <!-- ç™¼ç¾åœ°é» -->
        <div style="margin-top:16px;">
          <label>
            <span class="z-word"><span class="z-char">ç™¼</span><span class="z-yin"><span class="yin-symbol">ã„ˆ</span><span class="yin-symbol">ã„š</span></span></span>
            <span class="z-word"><span class="z-char">ç¾</span><span class="z-yin"><span class="yin-symbol">ã„’</span><span class="yin-symbol">ã„§</span><span class="yin-symbol">ã„¢</span><span class="tone tone-4">Ë‹</span></span></span>
            <span class="z-word"><span class="z-char">åœ°</span><span class="z-yin"><span class="yin-symbol">ã„‰</span><span class="yin-symbol">ã„§</span><span class="tone tone-4">Ë‹</span></span></span>
            <span class="z-word"><span class="z-char">é»</span><span class="z-yin"><span class="yin-symbol">ã„‰</span><span class="yin-symbol">ã„§</span><span class="yin-symbol">ã„¢</span><span class="tone tone-3">Ë‡</span></span></span>
          </label>
          <div class="input-group">
            <input id="locationInput" type="text" placeholder="">
            <button id="btnMicLocation" type="button" class="btn record">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg">
                <rect x="8" y="2" width="8" height="13" rx="4" ry="4"/>
                <path d="M5 10v2a7 7 0 0 0 14 0v-2" stroke="white" stroke-width="3" stroke-linecap="round" fill="none"/>
                <line x1="12" y1="19" x2="12" y2="22" stroke="white" stroke-width="3" stroke-linecap="round"/>
                <line x1="8" y1="22" x2="16" y2="22" stroke="white" stroke-width="3" stroke-linecap="round"/>
              </svg>
            </button>
          </div>
        </div>

        <div style="margin-top:16px;">
          <label>
            <span class="z-word"><span class="z-char">ç¾</span><span class="z-yin"><span class="yin-symbol">ã„’</span><span class="yin-symbol">ã„§</span><span class="yin-symbol">ã„¢</span><span class="tone tone-4">Ë‹</span></span></span>
            <span class="z-word"><span class="z-char">æ³</span><span class="z-yin"><span class="yin-symbol">ã„</span><span class="yin-symbol">ã„¨</span><span class="yin-symbol">ã„¤</span><span class="tone tone-4">Ë‹</span></span></span>
            <span class="z-word"><span class="z-char">æ</span><span class="z-yin"><span class="yin-symbol">ã„‡</span><span class="yin-symbol">ã„§</span><span class="yin-symbol">ã„ </span><span class="tone tone-2">ËŠ</span></span></span>
            <span class="z-word"><span class="z-char">è¿°</span><span class="z-yin"><span class="yin-symbol">ã„•</span><span class="yin-symbol">ã„¨</span><span class="tone tone-4">Ë‹</span></span></span>
          </label>
          <div class="input-group">
            <input id="problemInput" type="text" placeholder="">
            <button id="btnMicProblem" type="button" class="btn record">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg">
                <rect x="8" y="2" width="8" height="13" rx="4" ry="4"/>
                <path d="M5 10v2a7 7 0 0 0 14 0v-2" stroke="white" stroke-width="3" stroke-linecap="round" fill="none"/>
                <line x1="12" y1="19" x2="12" y2="22" stroke="white" stroke-width="3" stroke-linecap="round"/>
                <line x1="8" y1="22" x2="16" y2="22" stroke="white" stroke-width="3" stroke-linecap="round"/>
              </svg>
            </button>
          </div>
        </div>

        <div style="margin-top:16px;">
          <label>
            <span class="z-word"><span class="z-char">æ½›</span><span class="z-yin"><span class="yin-symbol">ã„‘</span><span class="yin-symbol">ã„§</span><span class="yin-symbol">ã„¢</span><span class="tone tone-2">ËŠ</span></span></span>
            <span class="z-word"><span class="z-char">åœ¨</span><span class="z-yin"><span class="yin-symbol">ã„—</span><span class="yin-symbol">ã„</span><span class="tone tone-4">Ë‹</span></span></span>
            <span class="z-word"><span class="z-char">é¢¨</span><span class="z-yin"><span class="yin-symbol">ã„ˆ</span><span class="yin-symbol">ã„¥</span></span></span>
            <span class="z-word"><span class="z-char">éšª</span><span class="z-yin"><span class="yin-symbol">ã„’</span><span class="yin-symbol">ã„§</span><span class="yin-symbol">ã„¢</span><span class="tone tone-3">Ë‡</span></span></span>
          </label>
          <div class="input-group">
            <input id="impactInput" type="text" placeholder="">
            <button id="btnMicImpact" type="button" class="btn record">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg">
                <rect x="8" y="2" width="8" height="13" rx="4" ry="4"/>
                <path d="M5 10v2a7 7 0 0 0 14 0v-2" stroke="white" stroke-width="3" stroke-linecap="round" fill="none"/>
                <line x1="12" y1="19" x2="12" y2="22" stroke="white" stroke-width="3" stroke-linecap="round"/>
                <line x1="8" y1="22" x2="16" y2="22" stroke="white" stroke-width="3" stroke-linecap="round"/>
              </svg>
            </button>
          </div>
        </div>

        <div style="margin-top:16px;">
          <label>
            <span class="z-word"><span class="z-char">æ”¹</span><span class="z-yin"><span class="yin-symbol">ã„</span><span class="yin-symbol">ã„</span><span class="tone tone-3">Ë‡</span></span></span>
            <span class="z-word"><span class="z-char">å–„</span><span class="z-yin"><span class="yin-symbol">ã„•</span><span class="yin-symbol">ã„¢</span><span class="tone tone-4">Ë‹</span></span></span>
            <span class="z-word"><span class="z-char">å°</span><span class="z-yin"><span class="yin-symbol">ã„‰</span><span class="yin-symbol">ã„¨</span><span class="yin-symbol">ã„Ÿ</span><span class="tone tone-4">Ë‹</span></span></span>
            <span class="z-word"><span class="z-char">ç­–</span><span class="z-yin"><span class="yin-symbol">ã„˜</span><span class="yin-symbol">ã„œ</span><span class="tone tone-4">Ë‹</span></span></span>
          </label>
          <div class="input-group">
            <input id="suggestionInput" type="text" placeholder="">
            <button id="btnMicSuggestion" type="button" class="btn record">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg">
                <rect x="8" y="2" width="8" height="13" rx="4" ry="4"/>
                <path d="M5 10v2a7 7 0 0 0 14 0v-2" stroke="white" stroke-width="3" stroke-linecap="round" fill="none"/>
                <line x1="12" y1="19" x2="12" y2="22" stroke="white" stroke-width="3" stroke-linecap="round"/>
                <line x1="8" y1="22" x2="16" y2="22" stroke="white" stroke-width="3" stroke-linecap="round"/>
              </svg>
            </button>
          </div>
        </div>

        <div style="margin-top:16px;">
          <label>
            <span class="z-word"><span class="z-char">é¢¨</span><span class="z-yin"><span class="yin-symbol">ã„ˆ</span><span class="yin-symbol">ã„¥</span></span></span>
            <span class="z-word"><span class="z-char">éšª</span><span class="z-yin"><span class="yin-symbol">ã„’</span><span class="yin-symbol">ã„§</span><span class="yin-symbol">ã„¢</span><span class="tone tone-3">Ë‡</span></span></span>
            <span class="z-word"><span class="z-char">ç­‰</span><span class="z-yin"><span class="yin-symbol">ã„‰</span><span class="yin-symbol">ã„¥</span><span class="tone tone-3">Ë‡</span></span></span>
            <span class="z-word"><span class="z-char">ç´š</span><span class="z-yin"><span class="yin-symbol">ã„</span><span class="yin-symbol">ã„§</span><span class="tone tone-2">ËŠ</span></span></span>
          </label>
          <select id="severity">
            <option value="ğŸŸ¢ è¼•å¾®">ğŸŸ¢ è¼•å¾® (è¼•åº¦å½±éŸ¿/å°ç¯„åœ)</option>
            <option value="ğŸŸ¡ ä¸­åº¦">ğŸŸ¡ ä¸­åº¦ (ä¸­åº¦å½±éŸ¿/éœ€æ³¨æ„)</option>
            <option value="ğŸ”´ åš´é‡">ğŸ”´ åš´é‡ (é‡å¤§å½±éŸ¿/éœ€ç«‹å³è™•ç†)</option>
          </select>
        </div>

        <div style="margin-top:16px;">
          <label>
            <span class="z-word"><span class="z-char">å½±</span><span class="z-yin"><span class="yin-symbol">ã„§</span><span class="yin-symbol">ã„¥</span><span class="tone tone-3">Ë‡</span></span></span>
            <span class="z-word"><span class="z-char">éŸ¿</span><span class="z-yin"><span class="yin-symbol">ã„’</span><span class="yin-symbol">ã„§</span><span class="yin-symbol">ã„¤</span><span class="tone tone-3">Ë‡</span></span></span>
            <span class="z-word"><span class="z-char">å±¤</span><span class="z-yin"><span class="yin-symbol">ã„˜</span><span class="yin-symbol">ã„¥</span><span class="tone tone-2">ËŠ</span></span></span>
            <span class="z-word"><span class="z-char">é¢</span><span class="z-yin"><span class="yin-symbol">ã„‡</span><span class="yin-symbol">ã„§</span><span class="yin-symbol">ã„¢</span><span class="tone tone-4">Ë‹</span></span></span>
          </label>
          <div class="checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" name="scope" value="å®‰å…¨å½±éŸ¿">
              <span class="z-word"><span class="z-char">å®‰</span><span class="z-yin"><span class="yin-symbol">ã„¢</span></span></span>
              <span class="z-word"><span class="z-char">å…¨</span><span class="z-yin"><span class="yin-symbol">ã„‘</span><span class="yin-symbol">ã„©</span><span class="yin-symbol">ã„¢</span><span class="tone tone-2">ËŠ</span></span></span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" name="scope" value="ç’°å¢ƒå½±éŸ¿">
              <span class="z-word"><span class="z-char">ç’°</span><span class="z-yin"><span class="yin-symbol">ã„</span><span class="yin-symbol">ã„¨</span><span class="yin-symbol">ã„¢</span><span class="tone tone-2">ËŠ</span></span></span>
              <span class="z-word"><span class="z-char">å¢ƒ</span><span class="z-yin"><span class="yin-symbol">ã„</span><span class="yin-symbol">ã„§</span><span class="yin-symbol">ã„¥</span><span class="tone tone-4">Ë‹</span></span></span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" name="scope" value="å¥åº·å½±éŸ¿">
              <span class="z-word"><span class="z-char">å¥</span><span class="z-yin"><span class="yin-symbol">ã„</span><span class="yin-symbol">ã„§</span><span class="yin-symbol">ã„¢</span><span class="tone tone-4">Ë‹</span></span></span>
              <span class="z-word"><span class="z-char">åº·</span><span class="z-yin"><span class="yin-symbol">ã„</span><span class="yin-symbol">ã„¤</span></span></span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" name="scope" value="äººéš›å½±éŸ¿">
              <span class="z-word"><span class="z-char">äºº</span><span class="z-yin"><span class="yin-symbol">ã„–</span><span class="yin-symbol">ã„£</span><span class="tone tone-2">ËŠ</span></span></span>
              <span class="z-word"><span class="z-char">éš›</span><span class="z-yin"><span class="yin-symbol">ã„</span><span class="yin-symbol">ã„§</span><span class="tone tone-4">Ë‹</span></span></span>
            </label>
          </div>
        </div>

      </div>

      <div style="margin-top:30px; text-align:center;">
        <button id="btnGoPreview" type="button" class="btn large" disabled>
          ä¸‹ä¸€æ­¥ï¼šé è¦½å¿«å ± â¡
        </button>
        <div id="errorMsg" style="color:#d32f2f; margin-top:10px; font-weight:bold;"></div>
      </div>
      
    </div>

    <!-- === é é¢ 2ï¼šé è¦½å€ (æ–°èç¨¿æ¨¡å¼) === -->
    <div id="page-preview" class="page-section">
      <div class="row between" style="margin-bottom:15px;">
        <button id="btnBackEdit" type="button" class="btn back">â¬… ä¿®æ”¹å…§å®¹</button>
        <h3>å¿«å ±é è¦½</h3>
      </div>

      <div class="report-container">
        <div id="report">
          <!-- æ–°èé é¦– -->
          <div class="news-header">
            <!-- LOGO: èª¿æ•´ä½ç½®åˆ°å·¦ä¸Šè§’ï¼Œå‚ç›´ç½®ä¸­ -->
            <img src="https://lh3.googleusercontent.com/d/1ybyLQCc_DIAUeS23tz-sORNL43Vv2Kan" style="position: absolute; left: 0; top: 0; bottom: 0; margin: auto; height: 60px;" alt="Logo" crossorigin="anonymous">
            
            <div style="text-align:center; margin-bottom:10px;">
              <h1>
                <span class="z-word"><span class="z-char">æ°¸</span><span class="z-yin"><span class="yin-symbol">ã„©</span><span class="yin-symbol">ã„¥</span><span class="tone tone-3">Ë‡</span></span></span><span class="z-word"><span class="z-char">çºŒ</span><span class="z-yin"><span class="yin-symbol">ã„’</span><span class="yin-symbol">ã„©</span><span class="tone tone-4">Ë‹</span></span></span><span class="z-word"><span class="z-char">ç”Ÿ</span><span class="z-yin"><span class="yin-symbol">ã„•</span><span class="yin-symbol">ã„¥</span></span></span><span class="z-word"><span class="z-char">æ´»</span><span class="z-yin"><span class="yin-symbol">ã„</span><span class="yin-symbol">ã„¨</span><span class="yin-symbol">ã„›</span><span class="tone tone-2">ËŠ</span></span></span><span class="z-word"><span class="z-char">å°</span><span class="z-yin"><span class="yin-symbol">ã„’</span><span class="yin-symbol">ã„§</span><span class="yin-symbol">ã„ </span><span class="tone tone-3">Ë‡</span></span></span><span class="z-word"><span class="z-char">è¨˜</span><span class="z-yin"><span class="yin-symbol">ã„</span><span class="yin-symbol">ã„§</span><span class="tone tone-4">Ë‹</span></span></span><span class="z-word"><span class="z-char">è€…</span><span class="z-yin"><span class="yin-symbol">ã„“</span><span class="yin-symbol">ã„œ</span><span class="tone tone-3">Ë‡</span></span></span><span class="z-word"><span class="z-char">å¿«</span><span class="z-yin"><span class="yin-symbol">ã„</span><span class="yin-symbol">ã„¨</span><span class="yin-symbol">ã„</span><span class="tone tone-4">Ë‹</span></span></span><span class="z-word"><span class="z-char">å ±</span><span class="z-yin"><span class="yin-symbol">ã„…</span><span class="yin-symbol">ã„ </span><span class="tone tone-4">Ë‹</span></span></span>
              </h1>
            </div>
          </div>

          <!-- æ–°èæ¨™é¡Œ (ç”¨æˆ¶è¼¸å…¥) -->
          <div class="news-title-box">
            <div id="rTitleContainer" style="display:flex; justify-content:center; align-items:center; flex-wrap:wrap;">
               <!-- å‹•æ…‹ç”Ÿæˆçš„æ³¨éŸ³æ¨™é¡Œæœƒæ”¾åœ¨é€™è£¡ -->
            </div>
          </div>

          <!-- è¨˜è€…ç½²åèˆ‡æ—¥æœŸ (å«æ³¨éŸ³) -->
          <div class="news-info">
            <div>
              <span class="z-word"><span class="z-char">è¨˜</span><span class="z-yin"><span class="yin-symbol">ã„</span><span class="yin-symbol">ã„§</span><span class="tone tone-4">Ë‹</span></span></span><span class="z-word"><span class="z-char">è€…</span><span class="z-yin"><span class="yin-symbol">ã„“</span><span class="yin-symbol">ã„œ</span><span class="tone tone-3">Ë‡</span></span></span>ï¼š
              <span id="rReporter" class="input-highlight">---</span> / 
              <span id="rTeam">---</span> 
              <span class="z-word"><span class="z-char">å ±</span><span class="z-yin"><span class="yin-symbol">ã„…</span><span class="yin-symbol">ã„ </span><span class="tone tone-4">Ë‹</span></span></span><span class="z-word"><span class="z-char">å°</span><span class="z-yin"><span class="yin-symbol">ã„‰</span><span class="yin-symbol">ã„ </span><span class="tone tone-3">Ë‡</span></span></span>
            </div>
            <div>
              <span class="z-word"><span class="z-char">æ—¥</span><span class="z-yin"><span class="yin-symbol">ã„–</span><span class="tone tone-4">Ë‹</span></span></span><span class="z-word"><span class="z-char">æœŸ</span><span class="z-yin"><span class="yin-symbol">ã„‘</span><span class="yin-symbol">ã„§</span><span class="tone tone-2">ËŠ</span></span></span>ï¼š<span id="rTime">---</span>
            </div>
          </div>
          <hr style="border:1px solid #000; margin:5px 0 20px 0;">

          <!-- æ–°èç…§ç‰‡èˆ‡å…§æ–‡å®¹å™¨ -->
          <div class="news-content-wrapper">
            <!-- æ–°èç…§ç‰‡ (ç¸®å°ç‰ˆ: é™åˆ¶æœ€å¤§é«˜åº¦ç‚º250px, èƒŒæ™¯å…¨ç™½, ç„¡é‚Šæ¡†) -->
            <div class="news-photo-box">
              <img id="rImg" src="" style="max-width:100%; max-height:100%; object-fit:contain;" alt="æ–°èç…§ç‰‡">
            </div>
            <div style="text-align:center; color:#555; font-size:14px; margin-top:-5px; margin-bottom:10px;">
              â–² <span class="z-word"><span class="z-char">ç¾</span><span class="z-yin"><span class="yin-symbol">ã„’</span><span class="yin-symbol">ã„§</span><span class="yin-symbol">ã„¢</span><span class="tone tone-4">Ë‹</span></span></span><span class="z-word"><span class="z-char">å ´</span><span class="z-yin"><span class="yin-symbol">ã„”</span><span class="yin-symbol">ã„¤</span><span class="tone tone-3">Ë‡</span></span></span><span class="z-word"><span class="z-char">å¯¦</span><span class="z-yin"><span class="yin-symbol">ã„•</span><span class="tone tone-2">ËŠ</span></span></span><span class="z-word"><span class="z-char">æ³</span><span class="z-yin"><span class="yin-symbol">ã„</span><span class="yin-symbol">ã„¨</span><span class="yin-symbol">ã„¤</span><span class="tone tone-4">Ë‹</span></span></span><span class="z-word"><span class="z-char">ç…§</span><span class="z-yin"><span class="yin-symbol">ã„“</span><span class="yin-symbol">ã„ </span><span class="tone tone-4">Ë‹</span></span></span><span class="z-word"><span class="z-char">ç‰‡</span><span class="z-yin"><span class="yin-symbol">ã„†</span><span class="yin-symbol">ã„§</span><span class="yin-symbol">ã„¢</span><span class="tone tone-4">Ë‹</span></span></span>
            </div>

            <!-- æ–°èå…§æ–‡ (è‡ªå‹•ç”Ÿæˆå€) -->
            <div id="newsContent" class="news-content-block news-body">
              <!-- é€™è£¡æœƒå¡«å…¥å®Œæ•´çš„æ–°èç¨¿å…§å®¹ -->
            </div>
          </div>

          <div class="news-footer">
            ä¸­è¯é›»ä¿¡ï½œæ°¸çºŒç”Ÿæ´»å°è¨˜è€…è¡Œå‹•è¨ˆç•«ï½œ2026
          </div>
        </div>
      </div>

      <div class="text-center mt-4">
        <div id="finalStatus" style="margin-bottom:10px;"></div>
        <div class="row center">
          <button id="btnDownload" type="button" class="btn">â¬‡ ä¸‹è¼‰åœ–ç‰‡ (PNG)</button>
          <button id="btnUpload" type="button" class="btn large" style="width:auto;">â˜ ä¸Šå‚³é›²ç«¯ (PDF)</button>
        </div>
        <div style="margin-top:20px; font-size:12px; color:#999;">
          Apps Script URL: <span id="endpointShow"></span>
        </div>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    const APPS_SCRIPT_ENDPOINT = "https://script.google.com/macros/s/ä½ çš„éƒ¨ç½²ID/exec";
    document.getElementById("endpointShow").textContent = APPS_SCRIPT_ENDPOINT;

    /* --- å®‰å…¨è®€å–å‡½å¼ --- */
    function safeVal(id) {
        const el = document.getElementById(id);
        return el ? el.value : "";
    }

    /* --- æ ¸å¿ƒï¼šæ³¨éŸ³ HTML ç”Ÿæˆå‡½å¼ (å‚ç›´å †ç–Šç‰ˆ) --- */
    function getZWord(char, yin, tone) {
      let toneHtml = "";
      if (tone === "2") toneHtml = '<span class="tone tone-2">ËŠ</span>';
      else if (tone === "3") toneHtml = '<span class="tone tone-3">Ë‡</span>';
      else if (tone === "4") toneHtml = '<span class="tone tone-4">Ë‹</span>';
      else if (tone === "0") toneHtml = '<span class="tone tone-0">Ë™</span>';
      
      let verticalYin = "";
      if (yin) {
        // ä¿®æ­£ï¼šåµæ¸¬ä¸¦éæ¿¾éæ³¨éŸ³ç¬¦è™Ÿ (ä¾‹å¦‚è‹±æ–‡)
        const bopomofoRegex = /[\u3100-\u312F]/;
        for (let i = 0; i < yin.length; i++) {
          if (bopomofoRegex.test(yin[i])) {
            verticalYin += `<span class="yin-symbol">${yin[i]}</span>`;
          }
        }
      }

      return `<span class="z-word"><span class="z-char">${char}</span><span class="z-yin">${verticalYin}${toneHtml}</span></span>`;
    }

    /* --- å°çµ„æ³¨éŸ³å°ç…§è¡¨ --- */
    function getTeamZ(teamName) {
      if (!teamName) return "æœªé¸æ“‡";
      const zu = getZWord("çµ„","ã„—ã„¨","3");
      const mapping = {
        "Açµ„": `<span class="input-highlight" style="text-decoration:none;">A</span>${zu}`,
        "Bçµ„": `<span class="input-highlight" style="text-decoration:none;">B</span>${zu}`,
        "Cçµ„": `<span class="input-highlight" style="text-decoration:none;">C</span>${zu}`,
        "Dçµ„": `<span class="input-highlight" style="text-decoration:none;">D</span>${zu}`,
        "Eçµ„": `<span class="input-highlight" style="text-decoration:none;">E</span>${zu}`,
      };
      return mapping[teamName] || teamName;
    }

    // æ“´å……è©å½™åº«ï¼šåŒ…å«æ–°éœ€æ±‚è©å½™
    const Z_DICT = {
      "æœ¬å ±": getZWord("æœ¬","ã„…ã„£","3") + getZWord("å ±","ã„…ã„ ","4"),
      "æœ¬": getZWord("æœ¬","ã„…ã„£","3"),
      "å ±": getZWord("å ±","ã„…ã„ ","4"),
      "ç¶“": getZWord("ç¶“","ã„ã„§ã„¥","1"),
      "å¯¦éš›": getZWord("å¯¦","ã„•","2") + getZWord("éš›","ã„ã„§","4"),
      "å‹˜æŸ¥": getZWord("å‹˜","ã„ã„¢","1") + getZWord("æŸ¥","ã„”ã„š","2"),
      "ç™¼ç¾": getZWord("ç™¼","ã„ˆã„š","1") + getZWord("ç¾","ã„’ã„§ã„¢","4"),
      "æ­¤": getZWord("æ­¤","ã„˜","3"),
      "ç‹€æ³": getZWord("ç‹€","ã„“ã„¨ã„¤","4") + getZWord("æ³","ã„ã„¨ã„¤","4"),
      "æ": getZWord("æ","ã„ã„¨ã„¥","3"),
      "è¡ç”Ÿ": getZWord("è¡","ã„§ã„¢","3") + getZWord("ç”Ÿ","ã„•ã„¥","1"),
      "ä¹‹": getZWord("ä¹‹","ã„“","1"),
      "å®‰å…¨": getZWord("å®‰","ã„¢","1") + getZWord("å…¨","ã„‘ã„©ã„¢","2"),
      "éš±æ†‚": getZWord("éš±","ã„§ã„£","3") + getZWord("æ†‚","ã„§ã„¡","1"),
      "è©•ä¼°": getZWord("è©•","ã„†ã„§ã„¥","2") + getZWord("ä¼°","ã„ã„¨","1"),
      "é¢¨éšª": getZWord("é¢¨","ã„ˆã„¥","1") + getZWord("éšª","ã„’ã„§ã„¢","3"),
      "ç­‰ç´š": getZWord("ç­‰","ã„‰ã„¥","3") + getZWord("ç´š","ã„ã„§","2"),
      "å±¬æ–¼": getZWord("å±¬","ã„•ã„¨","3") + getZWord("æ–¼","ã„©","2"),
      "ä¸»è¦": getZWord("ä¸»","ã„“ã„¨","3") + getZWord("è¦","ã„§ã„ ","4"),
      "å½±éŸ¿": getZWord("å½±","ã„§ã„¥","3") + getZWord("éŸ¿","ã„’ã„§ã„¤","3"),
      "å±¤é¢": getZWord("å±¤","ã„˜ã„¥","2") + getZWord("é¢","ã„‡ã„§ã„¢","4"),
      "åŒ…æ‹¬": getZWord("åŒ…","ã„…ã„ ","1") + getZWord("æ‹¬","ã„ã„¨ã„š","1"),
      "å»ºè­°": getZWord("å»º","ã„ã„§ã„¢","4") + getZWord("è­°","ã„§","4"),
      "ç«‹å³": getZWord("ç«‹","ã„Œã„§","4") + getZWord("å³","ã„ã„§","2"),
      "æ¡å–": getZWord("æ¡","ã„˜ã„","3") + getZWord("å–","ã„‘ã„©","3"),
      "æ”¹å–„": getZWord("æ”¹","ã„ã„","3") + getZWord("å–„","ã„•ã„¢","4"),
      "å°ç­–": getZWord("å°","ã„‰ã„¨ã„Ÿ","4") + getZWord("ç­–","ã„˜ã„œ","4"),
      "å…±åŒ": getZWord("å…±","ã„ã„¨ã„¥","4") + getZWord("åŒ","ã„Šã„¨ã„¥","2"),
      "ç¶­è­·": getZWord("ç¶­","ã„¨ã„Ÿ","2") + getZWord("è­·","ã„ã„¨","4"),
      "æ ¡åœ’": getZWord("æ ¡","ã„’ã„§ã„ ","4") + getZWord("åœ’","ã„©ã„¢","2"),
      "ä»¥": getZWord("ä»¥","ã„§","3"), 
      "ç‰¹æ­¤": getZWord("ç‰¹","ã„Šã„œ","4") + getZWord("æ­¤","ã„˜","3"),
      "å ±å°": getZWord("å ±","ã„…ã„ ","4") + getZWord("å°","ã„‰ã„ ","3"),
      "æ°¸çºŒ": getZWord("æ°¸","ã„©ã„¥","3") + getZWord("çºŒ","ã„’ã„©","4"),
      "ç”Ÿæ´»": getZWord("ç”Ÿ","ã„•ã„¥","1") + getZWord("æ´»","ã„ã„¨","2"),
      "å°": getZWord("å°","ã„’ã„§ã„ ","3"),
      "è¨˜è€…": getZWord("è¨˜","ã„ã„§","4") + getZWord("è€…","ã„“ã„œ","3"),
      "ä½": getZWord("ä½","ã„¨ã„ŸË‹","4"),
      "æ–¼": getZWord("æ–¼","ã„©ËŠ","2"),
      "çš„": getZWord("çš„","Ë™ã„‰ã„œ","0"),
      "é€ ": getZWord("é€ ","ã„—ã„ ","4"),
      "æˆ": getZWord("æˆ","ã„”ã„¥","2"),
      "ä¾†": getZWord("ä¾†","ã„Œã„","2"),
      "é ": getZWord("é ","ã„©","4"),
      "é˜²": getZWord("é˜²","ã„ˆã„¤","2"),
      "é€": getZWord("é€","ã„Šã„¡","4"),
      "é": getZWord("é","ã„ã„¨ã„›","4"),
      "ä¸¦": getZWord("ä¸¦","ã„…ã„§ã„¥","4"),
      "å‘¼": getZWord("å‘¼","ã„ã„¨","1"),
      "ç±²": getZWord("ç±²","ã„©","4"),
      "åŒ": getZWord("åŒ","ã„Šã„¨ã„¥","2"),
      "å­¸": getZWord("å­¸","ã„’ã„©ã„","2"),
      "ç¶“": getZWord("ç¶“","ã„ã„§ã„¥","1"),
      "é": getZWord("é","ã„ã„¨ã„›","4"),
      "æ™‚": getZWord("æ™‚","ã„•","2"),
      "æ‡‰": getZWord("æ‡‰","ã„§ã„¥","1"),
      "æ³¨": getZWord("æ³¨","ã„“ã„¨","4"),
      "æ„": getZWord("æ„","ã„§","4")
    };

    /* --- 1. é é¢åˆ‡æ› --- */
    const pageEdit = document.getElementById('page-edit');
    const pagePreview = document.getElementById('page-preview');
    const btnGoPreview = document.getElementById('btnGoPreview');
    const btnBackEdit = document.getElementById('btnBackEdit');
    const errorMsg = document.getElementById('errorMsg');

    function switchPage(toPage) {
      pageEdit.classList.remove('active');
      pagePreview.classList.remove('active');
      toPage.classList.add('active');
      window.scrollTo(0, 0);
    }

    /* --- 2. Canvas --- */
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const photoInput = document.getElementById("photoInput");
    const placeholderText = document.getElementById("placeholderText");
    let baseImage = null;
    let circles = [];
    let isDrawing = false;
    let startX, startY;
    const MAX_W = 1200; const MAX_H = 900;

    function resizeCanvas(img) {
      let w = img.width; let h = img.height;
      const scale = Math.min(MAX_W / w, MAX_H / h);
      w = Math.floor(w * scale); h = Math.floor(h * scale);
      canvas.width = w; canvas.height = h;
      return {w, h};
    }

    function redraw() {
      if(!baseImage) return;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(baseImage, 0, 0, canvas.width, canvas.height);
      ctx.lineWidth = 8; ctx.strokeStyle = "rgba(255, 0, 0, 0.8)";
      circles.forEach(circle => {
        ctx.beginPath();
        ctx.ellipse(circle.x, circle.y, circle.rx, circle.ry, 0, 0, Math.PI * 2);
        ctx.stroke();
      });
    }

    function getPos(e) {
      const rect = canvas.getBoundingClientRect();
      let clientX, clientY;
      if (e.touches && e.touches.length > 0) {
        clientX = e.touches[0].clientX;
        clientY = e.touches[0].clientY;
      } else if (e.changedTouches && e.changedTouches.length > 0) {
        clientX = e.changedTouches[0].clientX;
        clientY = e.changedTouches[0].clientY;
      } else {
        clientX = e.clientX;
        clientY = e.clientY;
      }
      return { x: (clientX - rect.left) * (canvas.width / rect.width), y: (clientY - rect.top) * (canvas.height / rect.height) };
    }

    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('touchstart', startDraw, {passive:false});
    window.addEventListener('mousemove', moveDraw);
    window.addEventListener('touchmove', moveDraw, {passive:false});
    window.addEventListener('mouseup', endDraw);
    window.addEventListener('touchend', endDraw);

    function startDraw(e) { 
      if(!baseImage) return; 
      isDrawing = true; 
      const pos = getPos(e);
      startX = pos.x;
      startY = pos.y;
      e.preventDefault(); 
    }

    function moveDraw(e) { 
      if(!isDrawing) return; 
      const pos = getPos(e);
      const rx = Math.abs(pos.x - startX);
      const ry = Math.abs(pos.y - startY);
      redraw();
      ctx.beginPath();
      ctx.ellipse(startX, startY, rx, ry, 0, 0, Math.PI * 2);
      ctx.stroke();
      e.preventDefault(); 
    }

    function endDraw(e) { 
      if(!isDrawing) return;
      isDrawing = false; 
      const pos = getPos(e);
      const rx = Math.abs(pos.x - startX);
      const ry = Math.abs(pos.y - startY);
      if(rx > 5 || ry > 5) circles.push({x: startX, y: startY, rx: rx, ry: ry});
      redraw();
      checkReady(); 
    }

    photoInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if(!file) return;
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = () => { resizeCanvas(img); baseImage = img; circles = []; canvas.classList.remove('hidden'); placeholderText.classList.add('hidden'); redraw(); checkReady(); URL.revokeObjectURL(url); };
      img.src = url;
    });

    document.getElementById('btnUndo').addEventListener('click', () => { circles.pop(); redraw(); checkReady(); });
    document.getElementById('btnClear').addEventListener('click', () => { circles = []; redraw(); checkReady(); });

    function checkReady() {
      const hasImg = !!baseImage;
      document.getElementById('btnUndo').disabled = !hasImg || circles.length === 0;
      document.getElementById('btnClear').disabled = !hasImg || circles.length === 0;
      btnGoPreview.disabled = !hasImg;
      if(hasImg) {
        document.getElementById('drawStatus').textContent = "âœ… ç…§ç‰‡å·²å°±ç·’";
        errorMsg.textContent = "";
      }
    }

    /* --- 3. æ¬„ä½äº’å‹• --- */
    const locationInput = document.getElementById("locationInput");
    const problemInput = document.getElementById("problemInput");
    const impactInput = document.getElementById("impactInput");
    const suggestionInput = document.getElementById("suggestionInput");

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      function setupSpeechRecognition(btnId, inputId) {
        const btn = document.getElementById(btnId);
        const input = document.getElementById(inputId);
        if(!btn || !input) return;
        
        let recognition = null;
        let isRecording = false;

        const stopRecording = () => {
          if (recognition) {
            recognition.stop();
            recognition = null;
          }
          isRecording = false;
          btn.classList.remove('recording');
        };

        const startRecording = () => {
          try {
            recognition = new SpeechRecognition();
            recognition.lang = 'zh-TW';
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onstart = () => {
              isRecording = true;
              btn.classList.add('recording');
            };

            recognition.onend = () => {
              stopRecording();
            };

            recognition.onresult = (event) => {
              let txt = event.results[0][0].transcript;
              if(txt.endsWith("ã€‚") || txt.endsWith("ï¼Œ") || txt.endsWith("ï¼")) {
                 txt = txt.slice(0, -1);
              }
              input.value = txt;
            };

            recognition.onerror = (event) => {
              console.error("Voice Error:", event.error);
              stopRecording();
              if (event.error === 'not-allowed') {
                alert("ç„¡æ³•éŒ„éŸ³ï¼šè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®šï¼Œå…è¨±ä½¿ç”¨éº¥å…‹é¢¨ã€‚");
              } else if (event.error === 'no-speech') {
              } else {
                alert("éŒ„éŸ³å¤±æ•—ï¼Œè«‹é‡è©¦ (" + event.error + ")");
              }
            };

            recognition.start();
          } catch (e) {
            console.error(e);
            alert("æ‚¨çš„è£ç½®ä¸æ”¯æ´æ­¤éŒ„éŸ³åŠŸèƒ½ï¼Œè«‹æ‰‹å‹•è¼¸å…¥ã€‚");
            stopRecording();
          }
        };

        btn.addEventListener('click', (e) => { 
          if (isRecording) {
            stopRecording();
          } else {
            startRecording();
          }
        });
      }
      setupSpeechRecognition("btnMicLocation", "locationInput");
      setupSpeechRecognition("btnMicProblem", "problemInput");
      setupSpeechRecognition("btnMicImpact", "impactInput");
      setupSpeechRecognition("btnMicSuggestion", "suggestionInput");
    } else {
      document.querySelectorAll('.btn.record').forEach(el => el.style.display = 'none');
    }

    /* --- 4. AI æ™ºæ…§æ”¹å¯«åŠŸèƒ½ --- */
    async function callGeminiAI(imageBase64, p, i, s, sev, scope, reporter, loc) {
      const apiKey = "AIzaSyBtQP-z4z0ik2WToErLcn0h_2VrEr62Y8E"; 
      if (!apiKey) return null; 

      const prompt = `
        è§’è‰²ï¼šä½ æ˜¯åœ‹å°çš„ã€Œæ°¸çºŒç”Ÿæ´»å°è¨˜è€…ã€æŒ‡å°è€å¸«ã€‚
        ä»»å‹™ï¼šæ ¹æ“šä½¿ç”¨è€…æä¾›çš„è³‡è¨Šï¼Œæ’°å¯«ä¸€ç¯‡ç´„ 100-150 å­—çš„æ–°èå¿«å ±ã€‚
        
        ã€ä½¿ç”¨è€…æä¾›è³‡è¨Šã€‘
        - è¨˜è€…å§“åï¼š${reporter}
        - ç™¼ç¾åœ°é»ï¼š${loc}
        - ç™¼ç¾å•é¡Œï¼š${p}
        - æ½›åœ¨é¢¨éšªï¼š${i}
        - æ”¹å–„å»ºè­°ï¼š${s} (é‡å°å­¸æ ¡/è¨­æ–½çš„å»ºè­°)
        - é¢¨éšªç­‰ç´šï¼š${sev}
        - å½±éŸ¿å±¤é¢ï¼š${scope}
        
        ã€æ–‡ç« çµæ§‹èˆ‡å…§å®¹è¦æ±‚ã€‘
        1. **ç¬¬ä¸€æ®µ (ç™¼ç¾èˆ‡é¢¨éšª)**ï¼šé–‹é ­å¿…é ˆæ˜¯ï¼šã€Œæœ¬å ±å°è¨˜è€…${reporter}ï¼Œç™¼ç¾...ã€ã€‚è«‹å°‡ã€Œåœ°é»ã€ã€ã€Œå•é¡Œã€èˆ‡ã€Œæ½›åœ¨é¢¨éšªã€è‡ªç„¶åœ°èåˆåœ¨ç¬¬ä¸€æ®µä¸­ã€‚è«‹é©åº¦æ½¤é£¾æ–‡å­—ï¼Œå»é™¤éå¿…è¦çš„è´…è© (å¦‚ï¼šå› æ­¤ã€é€²è€Œã€ä¹‹)ï¼Œè®“æè¿°æ›´å…·é«”æ¸…æ¥šã€‚
        2. **ç¬¬äºŒæ®µ (æ”¹å–„èˆ‡é é˜²)**ï¼š
           - èªªæ˜å»ºè­°æ¡å–çš„æ”¹å–„æªæ–½ (åƒè€ƒä½¿ç”¨è€…æä¾›çš„å»ºè­°)ã€‚è‹¥ä½¿ç”¨è€…æœªæŒ‡å®šå–®ä½ï¼Œè«‹ä½¿ç”¨ã€Œæ ¡æ–¹ã€æˆ–ã€Œå¸«é•·ã€ï¼Œä¸è¦è‡ªè¡Œç·¨é€ ã€Œç¸½å‹™è™•ã€ç­‰ç‰¹å®šå–®ä½åç¨±ã€‚
           - **é—œéµè¦æ±‚**ï¼šè«‹ AI æ ¹æ“šä¸Šè¿°å•é¡Œæƒ…å¢ƒï¼Œè‡ªå‹•åˆ¤æ–·ä¸¦åŠ å…¥ã€Œåœ¨å•é¡Œå°šæœªæ”¹å–„å‰ï¼ŒåŒå­¸ç¶“éæ™‚æ‡‰è©²æ¡å–çš„è‡ªæˆ‘ä¿è­·/é é˜²æªæ–½ã€ã€‚ä¾‹å¦‚ï¼šå¦‚æœæ˜¯ç©æ°´ï¼Œå»ºè­°ã€Œå°å¿ƒè¡Œèµ°ã€ä¸è¦å¥”è·‘ã€ï¼›å¦‚æœæ˜¯è¨­æ–½æå£ï¼Œå»ºè­°ã€Œè«‹å‹¿é è¿‘ã€ç¹é“è€Œè¡Œã€ã€‚
           - **çµå°¾è¦æ±‚**ï¼šæ–‡ç« çµå°¾ä¸è¦ç‰¹åˆ¥èªªæ˜¯å“ªå€‹å–®ä½æé†’çš„ã€‚
        
        ã€èªæ°£èˆ‡æ ¼å¼ã€‘
        1. èªæ°£ï¼šå°ˆæ¥­æ–°èè¨˜è€…å£å»ï¼Œä½†ç”¨è©è¦é©åˆåœ‹å°å­¸ç”Ÿé–±è®€ (è¦ªåˆ‡ã€è­¦ç¤º)ã€‚
        2. è«‹ä»¥ JSON é™£åˆ—æ ¼å¼å›å‚³ï¼Œæ¯å€‹é™£åˆ—å…ƒç´ ä»£è¡¨ä¸€å€‹å­—æˆ–æ¨™é»ã€‚
        3. æ³¨éŸ³æ¬„ä½ (y) è¦å‰‡ï¼šå¿…é ˆä¸”åªèƒ½ä½¿ç”¨å°ç£æ³¨éŸ³ç¬¦è™Ÿ (ä¾‹å¦‚ï¼šã„…, ã„†, ã„‡, ã„ˆ, ã„§, ã„¨, ã„©, ã„š, ã„›...)ã€‚çµ•å°ç¦æ­¢ä½¿ç”¨ç¾…é¦¬æ‹¼éŸ³/è‹±æ–‡ã€‚
        4. è²èª¿è¦å‰‡ï¼š1è²ä¸æ¨™ï¼Œ2è²ËŠï¼Œ3è²Ë‡ï¼Œ4è²Ë‹ï¼Œè¼•è²Ë™(0)ã€‚
        5. æ¨™é»ç¬¦è™Ÿçš„ y å’Œ t ç‚ºç©ºå­—ä¸²ã€‚
        6. ç¯„ä¾‹ï¼š[{"c":"å¤§","y":"ã„‰ã„š","t":"4"},{"c":"å®¶","y":"ã„ã„§ã„š","t":"1"},{"c":"ï¼Œ","y":"","t":""}]
      `;

      const base64Data = imageBase64.split(',')[1];

      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{
              parts: [
                { text: prompt },
                { inline_data: { mime_type: "image/png", data: base64Data } }
              ]
            }],
            generationConfig: {
              responseMimeType: "application/json"
            }
          })
        });
        
        if (!response.ok) return null;
        const data = await response.json();
        if (!data.candidates || data.candidates.length === 0) return null;

        const rawText = data.candidates[0].content.parts[0].text;
        const firstBracket = rawText.indexOf('[');
        const lastBracket = rawText.lastIndexOf(']');
        let jsonStr = rawText;
        if (firstBracket !== -1 && lastBracket !== -1 && lastBracket > firstBracket) {
            jsonStr = rawText.substring(firstBracket, lastBracket + 1);
        }
        return JSON.parse(jsonStr);
      } catch (e) {
        console.error("AI Error:", e);
        return null; 
      }
    }

    /* --- 5. ç”Ÿæˆé è¦½èˆ‡å°ˆæ¥­æ–‡æ¡ˆ --- */
    btnGoPreview.addEventListener('click', async () => {
      if(!baseImage) { errorMsg.textContent = "è«‹å…ˆä¸Šå‚³ç…§ç‰‡ï¼"; return; }
      
      // UI é¡¯ç¤º Loading
      btnGoPreview.disabled = true;
      btnGoPreview.textContent = "æ­£åœ¨ç”Ÿæˆå¿«å ±...";

      const now = new Date();
      // æ™‚é–“æˆ³è¨˜ï¼šæ—¥æœŸ + æ™‚é–“ (HH:MM)
      const pad = n => String(n).padStart(2, '0');
      const timeStr = `${now.getFullYear()}/${pad(now.getMonth()+1)}/${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}`;
      document.getElementById('rTime').textContent = timeStr;
      
      const teamVal = safeVal('team');
      const reporterVal = safeVal('reporterName') || "å°è¨˜è€…";
      document.getElementById('rTeam').innerHTML = getTeamZ(teamVal);
      document.getElementById('rReporter').textContent = reporterVal;
      
      // è‡ªå‹•ç”Ÿæˆæ¨™é¡Œ
      let pVal = safeVal('problemInput') || "å•é¡Œ";
      let locVal = safeVal('locationInput') || "æ ¡åœ’";
      let autoTitle = "";
      
      if(locVal && pVal) {
          // æ¨™é¡Œæ–‡æ¡ˆå„ªåŒ–ï¼šåœ°é» + å•é¡Œ
          document.getElementById('rTitleContainer').innerHTML = `<span class="input-highlight" style="font-size:1.8rem">${locVal}ç™¼ç¾${pVal}ï¼</span>`;
      } else {
          document.getElementById('rTitleContainer').innerHTML = `<span class="input-highlight" style="font-size:1.8rem">æ ¡åœ’å®‰å…¨é€šå ±</span>`;
      }

      let iVal = safeVal('impactInput') || "é¢¨éšª";
      let sVal = safeVal('suggestionInput') || "å»ºè­°";
      let sev = safeVal('severity');
      let sevLevel = sev.split(" ")[1] || "æ™®é€š"; 

      const checkedScopes = Array.from(document.querySelectorAll('input[name="scope"]:checked')).map(cb => cb.value);
      let scopeText = checkedScopes.length > 0 ? checkedScopes.join("ã€") : "æ ¡åœ’ç’°å¢ƒ";

      // å–å¾—åœ–ç‰‡
      const currentImageBase64 = canvas.toDataURL('image/png');
      document.getElementById('rImg').src = currentImageBase64;

      // å˜—è©¦å‘¼å« AI
      let aiJson = await callGeminiAI(currentImageBase64, pVal, iVal, sVal, sevLevel, scopeText, reporterVal, locVal);

      if (aiJson && Array.isArray(aiJson)) {
        let aiHtml = "";
        aiJson.forEach(item => {
            if (item.y) aiHtml += getZWord(item.c, item.y, item.t);
            else aiHtml += item.c;
        });
        document.getElementById('newsContent').innerHTML = aiHtml;
      } else {
        // æ¨¡æ¿æ¨¡å¼ (Fallback) - æ›´æ–°ç‚ºæœ¬å ±å°è¨˜è€…é–‹é ­ï¼Œä¸¦èª¿æ•´æ¨™é»èˆ‡é€£æ¥è©
        let html = "";
        // æ®µè½ä¸€ï¼šæœ¬å ±å°è¨˜è€…...ç™¼ç¾...
        html += `<p><b>${Z_DICT["æœ¬"]}${Z_DICT["å ±"]}${Z_DICT["å°"]}${Z_DICT["è¨˜è€…"]} <span class="input-highlight">${reporterVal}</span>ï¼Œ</b> ${Z_DICT["ç™¼"]}${Z_DICT["ç¾"]}${Z_DICT["ä½"]}${Z_DICT["æ–¼"]} <span class="input-highlight">${locVal}</span> ${Z_DICT["çš„"]} <span class="input-highlight">${pVal}</span>ï¼Œ`;
        html += Z_DICT["æ­¤"] + Z_DICT["ç‹€æ³"] + Z_DICT["æ"] + Z_DICT["è¡ç”Ÿ"] + `<span class="input-highlight">${iVal}</span>` + Z_DICT["ä¹‹"] + Z_DICT["å®‰å…¨"] + Z_DICT["éš±æ†‚"] + "ã€‚</p>";
        
        // æ®µè½äºŒï¼šè©•ä¼°
        html += `<p>${Z_DICT["è©•ä¼°"]} ${Z_DICT["é¢¨éšª"]} ${Z_DICT["ç­‰ç´š"]} ${Z_DICT["å±¬æ–¼"]} <span class="input-highlight" style="color:#d32f2f;">${sevLevel}</span>ï¼Œ`;
        html += Z_DICT["ä¸»è¦"] + Z_DICT["å½±éŸ¿"] + Z_DICT["å±¤"] + Z_DICT["é¢"] + Z_DICT["åŒ…æ‹¬"] + `<span class="input-highlight">${scopeText}</span>ã€‚</p>`;
        
        // æ®µè½ä¸‰ï¼šå»ºè­° (æ ¡æ–¹+è¡Œäºº)
        html += `<p>${Z_DICT["å»ºè­°"]} ${Z_DICT["æ ¡åœ’"]} <span class="input-highlight">${sVal}</span> ${Z_DICT["æ”¹å–„"]}ï¼Œ${Z_DICT["ç¶­è­·"]} ${Z_DICT["å®‰å…¨"]}ã€‚`;
        html += `${Z_DICT["ä¸¦"]}${Z_DICT["å‘¼"]}${Z_DICT["ç±²"]}${Z_DICT["åŒ"]}${Z_DICT["å­¸"]}${Z_DICT["åœ¨"]} ${Z_DICT["æ”¹"]}${Z_DICT["å–„"]}${Z_DICT["å‰"]}ï¼Œ${Z_DICT["ç¶“"]}${Z_DICT["é"]}${Z_DICT["æ™‚"]}${Z_DICT["æ‡‰"]}${Z_DICT["æ³¨"]}${Z_DICT["æ„"]}${Z_DICT["å®‰"]}${Z_DICT["å…¨"]}ã€‚</p>`;
        
        document.getElementById('newsContent').innerHTML = html;
      }

      switchPage(pagePreview);
      btnGoPreview.disabled = false;
      btnGoPreview.textContent = "ä¸‹ä¸€æ­¥ï¼šé è¦½å¿«å ± â¡";
    });

    btnBackEdit.addEventListener('click', () => { switchPage(pageEdit); });

    /* --- 5. ä¸‹è¼‰ä¸Šå‚³ --- */
    const btnDownload = document.getElementById('btnDownload');
    const btnUpload = document.getElementById('btnUpload');
    const finalStatus = document.getElementById('finalStatus');

    btnDownload.addEventListener('click', async () => {
      finalStatus.textContent = "â³ åœ–ç‰‡ç”Ÿæˆä¸­...";
      try {
        const reportDiv = document.getElementById('report');
        const canvasShot = await html2canvas(reportDiv, { scale: 2, useCORS: true, allowTaint: true });
        const a = document.createElement("a");
        a.href = canvasShot.toDataURL("image/png");
        a.download = `å®‰å…¨å¿«å ±_${new Date().getTime()}.png`;
        a.click();
        finalStatus.innerHTML = "<span style='color:green'>âœ… åœ–ç‰‡å·²ä¸‹è¼‰</span>";
      } catch(e) { finalStatus.innerHTML = "<span style='color:red'>âŒ å¤±æ•—</span>"; }
    });

    btnUpload.addEventListener('click', async () => {
      if(APPS_SCRIPT_ENDPOINT.includes("ä½ çš„éƒ¨ç½²ID")) { finalStatus.innerHTML = "<span style='color:#b40'>âš  è«‹è¨­å®šç¶²å€</span>"; return; }
      finalStatus.textContent = "â³ ä¸Šå‚³ä¸­...";
      try {
        const reportDiv = document.getElementById('report');
        const reportCanvas = await html2canvas(reportDiv, { scale: 2, useCORS: true });
        
        const rTitleText = document.getElementById('rTitleContainer').textContent;
        const newsText = document.getElementById('newsContent').innerText;

        const payload = {
          timestamp: new Date().toISOString(),
          team: safeVal('team'),
          reporter: safeVal('reporterName'),
          title: rTitleText, 
          location: safeVal('locationInput'),
          problem: safeVal('problemInput'),
          impact: safeVal('impactInput'),
          suggestion: safeVal('suggestionInput'),
          severity: safeVal('severity'),
          analysis: newsText, 
          reportImage: reportCanvas.toDataURL("image/png"),  
          sceneImage: canvas.toDataURL("image/png")     
        };
        const res = await fetch(APPS_SCRIPT_ENDPOINT, { method: "POST", headers: { "Content-Type": "text/plain" }, body: JSON.stringify(payload) });
        const respData = await res.json();
        if(respData.pdfUrl) finalStatus.innerHTML = `âœ… <a href="${respData.pdfUrl}" target="_blank">PDF ä¸‹è¼‰</a>`;
        else finalStatus.innerHTML = "<span style='color:green'>âœ… ä¸Šå‚³æˆåŠŸ</span>";
      } catch(e) { finalStatus.innerHTML = "<span style='color:red'>âŒ ä¸Šå‚³å¤±æ•—</span>"; }
    });
  </script>
</body>
</html>
